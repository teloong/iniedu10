---
import Layout from '../layouts/Layout.astro';
import AdminSidebar from "../components/AdminSidebar.astro";
import '../styles/global.css';
---
<Layout title="Daftar Video">
<!-- Proteksi login (hanya jalan di browser) -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const supabaseUrl = 'https://jcfizceoycwdvpqpwhrj.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjZml6Y2VveWN3ZHZwcXB3aHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NzUzNzUsImV4cCI6MjA2NDE1MTM3NX0.Au9FzSYvpaX7SkaVrgJvIgK9fZu5Dq4cU_NI5iwY6aA';
  const supabase = createClient(supabaseUrl, supabaseKey);
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session || session.user.email !== "lemindes@gmail.com") {
      window.location.href = "/admin-login";
    }
  })();
</script>

  <div class="min-h-screen bg-gray-50 flex">
    <div class="sticky top-0 h-screen hidden md:block">
      <AdminSidebar active="daftar-video" />
    </div>
    <main class="flex-1 overflow-x-auto">
      <div class="max-w-5xl mx-auto px-4 py-8">
        
        <div
          id="video-success-alert"
          class="hidden text-green-600 font-semibold mb-4"
        >
        </div>
        <div class="mb-4 flex items-center gap-2">
          <input id="search-input" type="text" placeholder="Cari judul, kelas, mapel..." class="border rounded px-3 py-2 w-full max-w-xs focus:outline-none focus:ring focus:border-blue-300" />
        </div>
        <div class="bg-white rounded-xl shadow p-6">
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr class="bg-gray-100">
                <th class="px-4 py-2 text-left">Judul</th>
                <th class="px-4 py-2 text-left">Kelas</th>
                <th class="px-4 py-2 text-left">Mapel</th>
                <th class="px-4 py-2 text-left">Kursus</th>
                <th class="px-4 py-2 text-left">URL</th>
                <th class="px-4 py-2 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="video-list"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</Layout>
<script type="module">
  import { supabase, fetchVideos, subscribeVideos } from '/videos.js';

  // Proteksi akses admin
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session || session.user.email !== "lemindes@gmail.com") {
      window.location.href = "/admin-login";
    }
  })();

  // Simpan data hasil fetch untuk kebutuhan filter
  let allVideos = [];

  // Render daftar video (dengan opsional filter)
  function renderVideos(filtered = null) {
    const tbody = document.getElementById("video-list");
    const videos = filtered !== null ? filtered : allVideos;
    tbody.innerHTML = "";
    if (!videos || videos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada video.</td></tr>';
      return;
    }
    for (const video of videos) {
      tbody.innerHTML += `
      <tr>
        <td class="px-4 py-2">${video.title || "-"}</td>
        <td class="px-4 py-2">${video.kelas || "-"}</td>
        <td class="px-4 py-2">${video.mapel || "-"}</td>
        <td class="px-4 py-2">${video.id_kursus || "-"}</td>
        <td class="px-4 py-2"><a href="${video.url}" class="text-blue-600 hover:underline" target="_blank">Lihat</a></td>
        <td class="px-4 py-2">
          <a href="/admin-video?edit=${video.id}" class="text-blue-600 hover:underline btn-edit-video" data-id="${video.id}">Edit</a>
          <button class="text-red-600 hover:underline btn-hapus-video ml-2" data-id="${video.id}">Hapus</button>
        </td>
      </tr>
      `;
    }
  }

  // Fetch dan render awal
  async function fetchAndRenderVideos() {
    const { data, error } = await fetchVideos();
    const tbody = document.getElementById("video-list");
    if (error) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-600">Gagal memuat data video.</td></tr>';
      return;
    }
    allVideos = data || [];
    renderVideos();
  }

  // Subscribe realtime perubahan videos
  subscribeVideos(() => {
    fetchAndRenderVideos();
  });

  // Event search
  document.addEventListener("DOMContentLoaded", async () => {
    await fetchAndRenderVideos();
    document.getElementById("video-success-alert").classList.add("hidden");
    // Event delegation untuk tombol hapus
    document
      .getElementById("video-list")
      .addEventListener("click", function (e) {
        if (e.target.classList.contains("btn-hapus-video")) {
          document
        }
      });
    // Fitur search
    const searchInput = document.getElementById("search-input");
    searchInput.addEventListener("input", function () {
      const q = this.value.trim().toLowerCase();
      if (!q) {
        renderVideos();
        return;
      }
      const filtered = allVideos.filter(v =>
        (v.title || "").toLowerCase().includes(q) ||
        (v.kelas ? String(v.kelas).toLowerCase() : "").includes(q) ||
        (v.mapel || "").toLowerCase().includes(q)
      );
      renderVideos(filtered);
    });
  });

  window.hapusVideo = async function (id) {
    const { error } = await supabase.from("videos").delete().eq("id", id);
    if (!error) {
      const alertBox = document.getElementById("video-success-alert");
      alertBox.textContent = "Video berhasil dihapus!";
      alertBox.classList.remove("hidden");
      // Hapus baris video dari tabel tanpa reload
      const row = document
        .querySelector(`button.btn-hapus-video[data-id="${id}"]`)
        .closest("tr");
      if (row) row.remove();
    }
  };

  document.addEventListener("DOMContentLoaded", async () => {
    await renderVideos();
    document.getElementById("video-success-alert").classList.add("hidden");
    // Event delegation untuk tombol hapus
    document
      .getElementById("video-list")
      .addEventListener("click", function (e) {
        if (e.target.classList.contains("btn-hapus-video")) {
          document
            .getElementById("video-success-alert")
            .classList.add("hidden");
          const id = e.target.getAttribute("data-id");
          window.hapusVideo(id);
        }
        if (e.target.classList.contains("btn-edit-video")) {
          document
            .getElementById("video-success-alert")
            .classList.add("hidden");
        }
      });
  });
</script>

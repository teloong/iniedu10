---
import Layout from '../layouts/Layout.astro';
import AdminSidebar from '../components/AdminSidebar.astro';
import '../styles/global.css';
---
<Layout title="Edit E-Book">
  <div class="min-h-screen bg-gray-50 flex">
    <div class="sticky top-0 h-screen hidden md:block">
      <AdminSidebar active="daftar-ebook" />
    </div>
    <main class="flex-1 overflow-x-auto">
      <div class="max-w-2xl mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold text-blue-700 mb-6">Edit E-Book</h1>
        <form id="edit-ebook-form" class="space-y-4">
          <input type="hidden" id="ebook-id" />
          <div>
            <label class="block mb-1 font-semibold">Judul</label>
            <input type="text" id="judul" class="w-full border rounded px-3 py-2" required />
          </div>
          <div>
            <label class="block mb-1 font-semibold">Penulis</label>
            <input type="text" id="penulis" class="w-full border rounded px-3 py-2" required />
          </div>
          <div>
            <label class="block mb-1 font-semibold">Tahun</label>
            <input type="number" id="tahun" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block mb-1 font-semibold">Penerbit</label>
            <input type="text" id="penerbit" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block mb-1 font-semibold">Deskripsi</label>
            <textarea id="deskripsi" class="w-full border rounded px-3 py-2"></textarea>
          </div>
          <div>
            <label class="block mb-1 font-semibold">Link</label>
            <input type="url" id="link" class="w-full border rounded px-3 py-2" required />
          </div>
          <div>
            <label class="block mb-1 font-semibold">Cover (URL gambar)</label>
            <input type="url" id="cover" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block mb-1 font-semibold">Kategori</label>
            <select id="kategori_id" class="w-full border rounded px-3 py-2" required></select>
          </div>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded">Simpan Perubahan</button>
        </form>
        <div id="edit-status" class="mt-4"></div>
      </div>
    </main>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://jcfizceoycwdvpqpwhrj.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjZml6Y2VveWN3ZHZwcXB3aHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NzUzNzUsImV4cCI6MjA2NDE1MTM3NX0.Au9FzSYvpaX7SkaVrgJvIgK9fZu5Dq4cU_NI5iwY6aA');

    function getQueryId() {
      const url = new URL(window.location.href);
      return url.searchParams.get('id');
    }

    async function loadKategori() {
      const { data, error } = await supabase.from('ebook_categories').select('*').order('nama', { ascending: true });
      const select = document.getElementById('kategori_id');
      if (error) {
        select.innerHTML = '<option value="">Gagal memuat kategori</option>';
        return;
      }
      select.innerHTML = data.map(cat => `<option value="${cat.id}">${cat.nama}</option>`).join('');
    }

    async function loadEbook() {
      const id = getQueryId();
      if (!id) {
        document.getElementById('edit-status').innerHTML = '<span class="text-red-500">ID e-book tidak ditemukan.</span>';
        document.getElementById('edit-ebook-form').style.display = 'none';
        return;
      }
      const { data, error } = await supabase.from('ebooks').select('*').eq('id', id).single();
      if (error || !data) {
        document.getElementById('edit-status').innerHTML = '<span class="text-red-500">E-book tidak ditemukan.</span>';
        document.getElementById('edit-ebook-form').style.display = 'none';
        return;
      }
      document.getElementById('ebook-id').value = data.id;
      document.getElementById('judul').value = data.judul || '';
      document.getElementById('penulis').value = data.penulis || '';
      document.getElementById('tahun').value = data.tahun || '';
      document.getElementById('penerbit').value = data.penerbit || '';
      document.getElementById('deskripsi').value = data.deskripsi || '';
      document.getElementById('link').value = data.link || '';
      document.getElementById('cover').value = data.cover || '';
      document.getElementById('kategori_id').value = data.kategori_id || '';
    }

    document.getElementById('edit-ebook-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('ebook-id').value;
      const judul = document.getElementById('judul').value;
      const penulis = document.getElementById('penulis').value;
      const tahun = document.getElementById('tahun').value;
      const penerbit = document.getElementById('penerbit').value;
      const deskripsi = document.getElementById('deskripsi').value;
      const link = document.getElementById('link').value;
      const cover = document.getElementById('cover').value;
      const kategori_id = document.getElementById('kategori_id').value;
      const { error } = await supabase.from('ebooks').update({ judul, penulis, tahun, penerbit, deskripsi, link, cover, kategori_id }).eq('id', id);
      if (error) {
        document.getElementById('edit-status').innerHTML = '<span class="text-red-500">Gagal menyimpan perubahan: ' + error.message + '</span>';
        return;
      }
      document.getElementById('edit-status').innerHTML = '<span class="text-green-600">Perubahan berhasil disimpan! Mengalihkan...</span>';
      setTimeout(() => {
        window.location.href = '/admin-daftar-ebook';
      }, 1200);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      await loadKategori();
      await loadEbook();
    });
  </script>
</Layout>

---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Profil Saya - IniEdu">
  <section class="max-w-xl mx-auto mt-12 bg-white rounded-2xl shadow-lg p-8">
    <h1 class="text-2xl font-bold text-center mb-6 text-blue-700">Profil Saya</h1>
    <div id="profile-info" class="text-center">Memuat profil...</div>
    <script type="module">
      import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js';
      import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

      async function loadFirebaseConfig() {
        return new Promise((resolve) => {
          const script = document.createElement('script');
          script.src = '/firebase-config.js';
          script.onload = () => resolve(window.firebaseConfig);
          document.head.appendChild(script);
        });
      }

      const firebaseConfig = await loadFirebaseConfig();
      const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const profileDiv = document.getElementById('profile-info');
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Ambil data user dari Firestore
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const data = userSnap.data();
            profileDiv.innerHTML = `
              <div class="mb-2"><b>Email:</b> ${user.email}</div>
              <div class="mb-2"><b>Nama:</b> ${data.nama || '-'}</div>
              <div class="mb-2"><b>Role:</b> ${data.role || '-'}</div>
              <button id="logout-btn" class="mt-4 px-6 py-2 rounded bg-red-500 hover:bg-red-600 text-white font-bold transition-all">Logout</button>
            `;
          } else {
            profileDiv.innerHTML = `
              <div class="mb-2"><b>Email:</b> ${user.email}</div>
              <div class="mb-2 text-red-500">Data user belum lengkap di database.</div>
              <button id="logout-btn" class="mt-4 px-6 py-2 rounded bg-red-500 hover:bg-red-600 text-white font-bold transition-all">Logout</button>
            `;
          }
          // Tambahkan event logout
          const logoutBtn = document.getElementById('logout-btn');
          if (logoutBtn) {
            logoutBtn.onclick = async () => {
              await auth.signOut();
              window.location.href = "/login";
            };
          }
        } else {
          window.location.href = "/login";
        }
      });
    </script>
  </section>
</Layout>
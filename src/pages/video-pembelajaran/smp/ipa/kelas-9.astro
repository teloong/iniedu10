---
import Layout from '../../../../layouts/Layout.astro';
---
<Layout title="Video Pembelajaran SMP - IPA Kelas 9">
  <section class="max-w-2xl mx-auto mt-12 bg-white rounded-2xl shadow-lg p-8">
    <h1 class="text-2xl font-bold text-center mb-6 text-yellow-700">
      Video Pembelajaran SMP - IPA Kelas 9
    </h1>
    <div id="video-list" class="space-y-8"></div>
    <div id="video-message" class="text-center text-red-500 mt-6"></div>
    <script type="module">
      import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      const firebaseConfig = {
        apiKey: "AIzaSyAlxYWD4bCwpoKEErXDX1_4AZC9wzQTkwA",
        authDomain: "iniedu.firebaseapp.com",
        projectId: "iniedu",
        storageBucket: "iniedu.appspot.com",
        messagingSenderId: "743403637628",
        appId: "1:743403637628:web:15b40396e94c8b91ce32f9",
      };
      if (!getApps().length) {
        initializeApp(firebaseConfig);
      }
      const auth = getAuth();
      const videoList = document.getElementById("video-list");
      const videoMessage = document.getElementById("video-message");

      async function fetchVideosWithToken(token) {
        videoMessage.textContent = "";
        videoList.innerHTML = "";
        try {
          const kelas = 9;
          const mapel = "IPA";
          const res = await fetch(
            "https://jcfizceoycwdvpqpwhrj.functions.supabase.co/akses_video",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token, kelas, mapel }),
            }
          );
          const { videos } = await res.json();
          if (!Array.isArray(videos) || videos.length === 0) {
            videoMessage.textContent = "Belum ada video untuk mapel ini.";
            return;
          }
          videos.forEach((video) => {
            let embed = "";
            if (video.url) {
              let videoId = "";
              const match = video.url.match(
                /(?:youtu.be\/|youtube.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/
              );
              if (match) {
                videoId = match[1];
              }
              if (videoId) {
                embed = `<iframe src='https://www.youtube.com/embed/${videoId}' class='w-full aspect-video rounded mb-2' frameborder='0' allowfullscreen></iframe>`;
              }
            }
            videoList.innerHTML += `
              <div class='border rounded-xl p-4 shadow bg-yellow-50'>
                ${embed}
                <div class='font-bold mb-1'>${video.judul || 'Tanpa Judul'}</div>
                <div class='text-gray-600 text-sm mb-1'>${video.deskripsi || ''}</div>
                <div class='text-xs text-gray-400'>${video.tanggal ? new Date(video.tanggal).toLocaleDateString('id-ID') : ''}</div>
              </div>
            `;
          });
        } catch (err) {
          videoMessage.textContent = "Gagal memuat video. Silakan coba lagi.";
        }
      }
      onAuthStateChanged(auth, (user) => {
        if (user) {
          user.getIdToken().then(fetchVideosWithToken);
        } else {
          videoMessage.textContent = "Silakan login untuk melihat video.";
        }
      });
    </script>
  </section>
</Layout>
